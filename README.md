# Compress EPUB

一个简单的电子书压缩工具，支持 PDF 和 EPUB 格式。

## 功能特性

- 支持格式：PDF 和 EPUB 文件压缩
- 三种压缩级别：
  - 低压缩：最佳质量，文件体积较大
  - 中压缩：平衡质量和大小
  - 高压缩：最小文件体积
- 拖拽上传功能
- 实时压缩进度显示
- 支持大文件（最大 50MB）

## 本地部署

### 环境要求

- Node.js >= 14

### 安装步骤

1. 克隆仓库

## 技术栈

- Frontend: HTML, CSS, JavaScript
- Backend: Node.js, Express
- PDF Processing: pdf-lib
- EPUB Processing: adm-zip, sharp, jimp

## 开发日志

### 2024-03-xx
- 初始版本发布
- 实现基本的文件上传和压缩功能

### 2024-03-xx
- 优化 PDF 压缩算法
- 添加详细的日志记录
- 改进错误处理机制

### 2024-02-27
- 将 PDF 压缩从 Ghostscript 迁移到纯 JavaScript 的 pdf-lib 库
- 优化 Vercel 部署配置
- 移除系统级依赖，提高兼容性

## 待优化项目

- [ ] 优化 PDF 压缩效果
- [ ] 添加压缩预览功能
- [ ] 支持批量文件处理
- [ ] 添加文件完整性验证

## 技术文档

### 技术栈
- 前端：HTML, CSS, JavaScript
- 后端：Node.js
- 文件处理：pdf-lib (PDF处理), adm-zip, sharp, jimp (EPUB处理)

### 项目结构 

## 问题记录与解决方案

### Vercel 部署问题

**问题描述：**
- Vercel 部署时无法安装 Ghostscript 依赖
- 构建失败，无法找到 libgs.so 库文件

**原因分析：**
1. Vercel 是无服务器平台，不支持系统级依赖
2. Ghostscript 需要系统级库支持
3. 无法在 Vercel 环境中安装和配置 Ghostscript

**解决方案：**
使用纯 JavaScript 实现的替代方案：
1. 使用 pdf-lib 库替代 Ghostscript
2. 移除所有系统级依赖
3. 更新压缩算法以适应新的库
4. 修改 Vercel 配置文件

**经验总结：**
1. 在无服务器环境中应避免使用系统级依赖
2. 尽可能使用纯 JavaScript 实现的库
3. 在部署前测试兼容性
4. 针对不同的部署环境选择合适的技术栈

### PDF 压缩级别问题

**问题描述：**
- Low 压缩级别导致文件变大（39.04 MB → 43.76 MB）
- Medium 和 High 级别工作正常

**原因分析：**
1. 默认的压缩设置保留了过多原始数据
2. 高分辨率导致某些元素被重新渲染为更高质量
3. 某些参数组合导致文件膨胀而不是压缩

**解决方案：**
使用以下参数组合成功解决：
1. Low 级别：
   - 图像质量设为 0.8
   - 保留元数据
   - 使用对象流压缩

2. Medium 级别：
   - 图像质量设为 0.6
   - 移除元数据
   - 使用对象流压缩

3. High 级别：
   - 图像质量设为 0.4
   - 移除元数据
   - 使用对象流压缩

**经验总结：**
1. PDF 压缩需要平衡质量和大小
2. 不同的压缩参数会产生显著不同的结果
3. 某些参数可能会意外增加文件大小
4. 测试不同参数组合很重要 

## 开发计划

### 1. 压缩预览功能 (优先级：高)
- [ ] 压缩前预览效果
- [ ] 不同压缩级别的对比预览
- [ ] 预览页面的缩放和翻页
- [ ] 实时质量对比功能

### 2. EPUB 格式支持 (优先级：高)
- [x] EPUB 文件解析和处理
- [x] 图片资源压缩
- [x] CSS 和 HTML 文件优化
- [x] 保持电子书格式和目录结构
- [x] EPUB 文件完整性验证

### 3. 批量文件处理 (优先级：中)
- [ ] 多文件同时上传
- [ ] 批量压缩队列
- [ ] 进度显示和管理
- [ ] 批量下载功能
- [ ] 失败任务重试机制

### 4. 压缩历史记录 (优先级：中)
- [ ] 本地存储压缩历史
- [ ] 显示历史压缩结果
- [ ] 重用历史压缩设置
- [ ] 历史记录管理（删除/导出）

### 5. 文件完整性验证 (优先级：低)
- [ ] 压缩前后的文件校验
- [ ] MD5/SHA256 校验和比对
- [ ] PDF 结构完整性检查
- [ ] 错误检测和报告
- [ ] 自动修复建议

## 开发进度

### 已完成功能
- [x] 基础文件上传
- [x] PDF 压缩（三种级别）
- [x] EPUB 压缩（三种级别）
- [x] 拖拽上传
- [x] 压缩进度显示
- [x] 优化 PDF 压缩参数配置
- [x] EPUB 图片和文本压缩
- [x] 纯 JavaScript 实现，无系统依赖

### 进行中
- [ ] 压缩预览功能开发
- [ ] 批量文件处理

### 待开始
- [ ] 压缩历史记录
- [ ] 文件完整性验证 