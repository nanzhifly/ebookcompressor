# Compress EPUB

一个简单的电子书压缩工具，支持 PDF 和 EPUB 格式。

## 功能特性

- 支持格式：PDF 和 EPUB 文件压缩
- 三种压缩级别：
  - 低压缩：最佳质量，文件体积较大
  - 中压缩：平衡质量和大小
  - 高压缩：最小文件体积
- 拖拽上传功能
- 实时压缩进度显示
- 支持大文件（最大 50MB）

## 本地部署

### 环境要求

- Node.js >= 14

### 安装步骤

1. 克隆仓库

## 技术栈

- Frontend: HTML, CSS, JavaScript
- Backend: Node.js, Express
- PDF Processing: pdf-lib
- EPUB Processing: adm-zip, sharp, jimp

## 开发日志

### 2024-03-xx
- 初始版本发布
- 实现基本的文件上传和压缩功能

### 2024-03-xx
- 优化 PDF 压缩算法
- 添加详细的日志记录
- 改进错误处理机制

### 2024-02-27
- 将 PDF 压缩从 Ghostscript 迁移到纯 JavaScript 的 pdf-lib 库
- 优化 Vercel 部署配置
- 移除系统级依赖，提高兼容性

## 待优化项目

- [ ] 优化 PDF 压缩效果
- [ ] 添加压缩预览功能
- [ ] 支持批量文件处理
- [ ] 添加文件完整性验证

## 技术文档

### 技术栈
- 前端：HTML, CSS, JavaScript
- 后端：Node.js
- 文件处理：pdf-lib (PDF处理), adm-zip, sharp, jimp (EPUB处理)

### 项目结构 

## 问题记录与解决方案

### Vercel 部署问题

**问题描述：**
- Vercel 部署时无法安装 Ghostscript 依赖
- 构建失败，无法找到 libgs.so 库文件

**原因分析：**
1. Vercel 是无服务器平台，不支持系统级依赖
2. Ghostscript 需要系统级库支持
3. 无法在 Vercel 环境中安装和配置 Ghostscript

**解决方案：**
使用纯 JavaScript 实现的替代方案：
1. 使用 pdf-lib 库替代 Ghostscript
2. 移除所有系统级依赖
3. 更新压缩算法以适应新的库
4. 修改 Vercel 配置文件

**经验总结：**
1. 在无服务器环境中应避免使用系统级依赖
2. 尽可能使用纯 JavaScript 实现的库
3. 在部署前测试兼容性
4. 针对不同的部署环境选择合适的技术栈

### PDF 压缩效果问题

**问题描述：**
- 不同压缩级别（low、medium、high）效果相似
- 压缩率极低（例如：39.04MB → 39.02MB，仅减少0.0%）
- 某些情况下文件反而变大

**测试数据：**

1. **测试文件类型**：
   - 文本为主的 PDF (学术论文)：20-40MB
   - 图片为主的 PDF (图册)：30-50MB
   - 混合内容 PDF (教材)：40-60MB
   - 扫描文档 PDF：20-30MB

2. **各方案压缩效果**：

   a. **Ghostscript 方案**（本地测试）
   - 文本PDF：减少40-60%
   - 图片PDF：减少50-70%
   - 混合PDF：减少45-65%
   - 原因：无法在 Vercel 部署

   b. **PDF.js 渲染重建**
   - 文本PDF：文件增大10-20%
   - 图片PDF：减少20-30%
   - 混合PDF：不稳定，±15%
   - 处理时间：2-5分钟/文件
   - 内存使用：500MB-1GB

   c. **PDF-lib 直接压缩**
   - 文本PDF：减少5-10%
   - 图片PDF：减少8-15%
   - 混合PDF：减少3-12%
   - 处理时间：30秒-2分钟
   - 内存使用：200-400MB

   d. **混合压缩引擎**
   - 文本PDF：减少10-15%
   - 图片PDF：减少15-25%
   - 混合PDF：减少12-20%
   - 处理时间：1-3分钟
   - 内存使用：300-600MB

   e. **流级别压缩**
   - 不稳定，常导致文件损坏
   - 成功案例压缩率：15-30%
   - 处理时间：1-4分钟
   - 内存使用：400-800MB

3. **Vercel 平台限制**：
   - 执行时间上限：30秒
   - 内存限制：1024MB
   - 部署包大小限制：50MB
   - Lambda 函数限制：50MB

4. **特殊情况测试**：
   - 大文件（>100MB）：总是失败
   - 加密PDF：无法处理
   - 字体嵌入PDF：压缩后字体显示异常
   - 表单PDF：交互功能丢失

**已尝试的方案：**

1. **Ghostscript 方案**
   - 尝试时间：项目初期
   - 实现方式：使用 Ghostscript 命令行工具进行压缩
   - 失败原因：Vercel 不支持系统级依赖
   - 结论：不可行，放弃

2. **PDF.js 渲染重建方案**
   - 实现方式：使用 PDF.js 渲染页面后重新生成 PDF
   - 问题：
     - 渲染质量不稳定
     - 文件大小不可控
     - 某些 PDF 元素丢失
   - 结论：效果不理想，放弃

3. **PDF-lib 直接压缩方案**
   - 实现方式：使用 PDF-lib 的 setCompression 和 setDeflateLevel
   - 问题：
     - 压缩效果不明显
     - 参数设置没有实际效果
   - 结论：API 限制，效果不理想

4. **混合压缩引擎方案**
   - 实现方式：结合图像压缩和内容流压缩
   - 问题：
     - 压缩效果不稳定
     - 不同级别效果相似
   - 结论：需要更精细的控制

5. **流级别压缩方案**
   - 实现方式：直接操作 PDF 流数据
   - 问题：
     - 某些流数据无法正确处理
     - 容易破坏 PDF 结构
   - 结论：风险高，效果不稳定

**下一步方案：**
计划实施分层压缩策略：
1. 分析不同类型内容（文本、图像、矢量图）
2. 对不同内容采用独立的压缩策略
3. 使用 PDF-lib 底层 API 精确控制压缩过程

**目标指标：**
1. **压缩效果**：
   - Low: 文件减少 10-20%，无质量损失
   - Medium: 文件减少 30-50%，允许轻微质量损失
   - High: 文件减少 50-70%，优先考虑大小

2. **性能要求**：
   - 处理时间：<30秒（Vercel 限制）
   - 内存使用：<900MB
   - 适用文件：≤50MB

3. **质量标准**：
   - 文本：保持清晰度和可选择性
   - 图像：可接受的视觉质量
   - 矢量图：保持边缘清晰
   - 字体：确保可读性
   - 超链接：保持可用性

**经验总结：**
1. Vercel 环境限制：
   - 不支持系统级依赖
   - 需要纯 JavaScript 实现
   - 注意内存和执行时间限制

2. PDF 压缩注意事项：
   - 需要平衡质量和大小
   - 不同内容类型需要不同策略
   - 避免过度压缩导致质量问题

3. 开发建议：
   - 优先考虑 Vercel 兼容性
   - 在实施前充分测试
   - 保持代码可维护性

### Web Worker 跨域加载问题

**问题描述：**
- Web Worker 无法从 CDN (unpkg.com) 加载外部脚本
- 报错：`Failed to execute 'importScripts' on 'WorkerGlobalScope'`
- 影响压缩功能的正常运行

**原因分析：**
1. Web Worker 的跨域限制比普通脚本更严格
2. 使用 CDN 加载脚本违反了同源策略
3. 缺少必要的 CORS 和安全头配置

**解决方案：**
1. 将外部库（pdf-lib 和 comlink）下载到本地 `/public/js/lib/` 目录
2. 修改所有脚本引用为本地路径
3. 在 `vercel.json` 中添加正确的配置：
   - 设置正确的 MIME 类型
   - 添加必要的安全头
   - 配置本地库文件的路由

**经验总结：**
1. Web Worker 的安全限制需要特别注意
2. 关键依赖最好使用本地托管而不是 CDN
3. 在项目初期就应该考虑跨域和安全策略
4. 正确配置 MIME 类型和安全头很重要

## 开发计划

### 1. 压缩预览功能 (优先级：高)
- [ ] 压缩前预览效果
- [ ] 不同压缩级别的对比预览
- [ ] 预览页面的缩放和翻页
- [ ] 实时质量对比功能

### 2. EPUB 格式支持 (优先级：高)
- [x] EPUB 文件解析和处理
- [x] 图片资源压缩
- [x] CSS 和 HTML 文件优化
- [x] 保持电子书格式和目录结构
- [x] EPUB 文件完整性验证

### 3. 批量文件处理 (优先级：中)
- [ ] 多文件同时上传
- [ ] 批量压缩队列
- [ ] 进度显示和管理
- [ ] 批量下载功能
- [ ] 失败任务重试机制

### 4. 压缩历史记录 (优先级：中)
- [ ] 本地存储压缩历史
- [ ] 显示历史压缩结果
- [ ] 重用历史压缩设置
- [ ] 历史记录管理（删除/导出）

### 5. 文件完整性验证 (优先级：低)
- [ ] 压缩前后的文件校验
- [ ] MD5/SHA256 校验和比对
- [ ] PDF 结构完整性检查
- [ ] 错误检测和报告
- [ ] 自动修复建议

## 开发进度

### 已完成功能
- [x] 基础文件上传
- [x] PDF 压缩（三种级别）
- [x] EPUB 压缩（三种级别）
- [x] 拖拽上传
- [x] 压缩进度显示
- [x] 优化 PDF 压缩参数配置
- [x] EPUB 图片和文本压缩
- [x] 纯 JavaScript 实现，无系统依赖

### 进行中
- [ ] 压缩预览功能开发
- [ ] 批量文件处理

### 待开始
- [ ] 压缩历史记录
- [ ] 文件完整性验证 